//
//  StreamingBasics.swift
//  SwiftResponsesDSL Examples
//
//  Basic examples showing how to use streaming responses
//  for real-time interactions with LLMs.
//
//  Generated by AI-assisted code generation.
//  Created by Richard Naszcyniec on [Date].
//  Copyright Â© [Year] Richard Naszcyniec. All rights reserved.
//

import SwiftResponsesDSL

/// Example 1: Basic Streaming
/// Shows the simplest way to use streaming responses
func basicStreamingExample() async throws {
    print("ğŸŒŠ Basic Streaming Example")
    print("==========================")

    let client = try LLMClient(baseURLString: "https://api.openai.com/v1/responses")

    let request = try ResponseRequest(
        model: "gpt-4",
        config: {
            StreamOptions(["include_usage": true])
        },
        input: {
            user("Write a short poem about the ocean")
        }
    )

    print("ğŸ“ Streaming response:")
    print("ğŸ¤– ", terminator: "")

    let stream = client.stream(request: request)
    var wordCount = 0

    for try await event in stream {
        switch event {
        case .created:
            print("(Stream started)", terminator: " ")

        case .inProgress:
            // Could show a progress indicator here
            break

        case .outputItemAdded(let item):
            if case .message(let message) = item,
               let content = message.content {
                // Print content as it arrives
                print(content, terminator: "")
                fflush(stdout) // Force immediate output
                wordCount += content.split(separator: " ").count
            }

        case .completed(let response):
            print("\nâœ… Stream completed!")
            print("ğŸ“Š Total words received: \(wordCount)")

            // Show usage statistics if available
            if let usage = response.usage {
                print("ğŸ“ˆ Token usage - Input: \(usage.inputTokens), Output: \(usage.outputTokens)")
            }

        case .unknown(let type, _):
            print("\nâš ï¸  Unknown event type: \(type)", terminator: " ")
        }
    }

    print("\nâœ… Basic streaming completed!")
}

/// Example 2: Streaming with Progress Indicators
/// Shows how to provide user feedback during streaming
func streamingWithProgressExample() async throws {
    print("\nğŸ“Š Streaming with Progress Example")
    print("==================================")

    let client = try LLMClient(baseURLString: "https://api.openai.com/v1/responses")

    let request = try ResponseRequest(
        model: "gpt-4",
        config: {
            Temperature(0.7)
            MaxOutputTokens(100)
            StreamOptions(["include_usage": true])
        },
        input: {
            user("Explain quantum computing in simple terms")
        }
    )

    print("ğŸ¤– Assistant is thinking...")
    var dots = 0
    var totalContent = ""

    let stream = client.stream(request: request)

    for try await event in stream {
        switch event {
        case .created:
            print("âœ… Connection established")

        case .inProgress:
            // Show thinking animation
            dots = (dots + 1) % 4
            let animation = String(repeating: ".", count: dots) + String(repeating: " ", count: 3 - dots)
            print("\rğŸ¤” Thinking\(animation)", terminator: "")
            fflush(stdout)

        case .outputItemAdded(let item):
            if case .message(let message) = item,
               let content = message.content {
                totalContent += content
                // Clear the thinking line and show content
                print("\rğŸ¤– \(totalContent)", terminator: "")
                fflush(stdout)
            }

        case .completed(let response):
            print("\nâœ… Response completed!")

            if let usage = response.usage {
                let totalTokens = usage.totalTokens
                let estimatedWords = totalContent.split(separator: " ").count
                print("ğŸ“Š Statistics:")
                print("   â€¢ Tokens used: \(totalTokens)")
                print("   â€¢ Estimated words: \(estimatedWords)")
                print("   â€¢ Avg tokens per word: \(Double(totalTokens) / Double(estimatedWords))")
            }

        case .unknown(let type, _):
            print("\nâš ï¸  Received unknown event: \(type)")
        }
    }

    print("âœ… Progress streaming completed!")
}

/// Example 3: Streaming with Cancellation
/// Shows how to cancel a streaming response mid-way
func streamingWithCancellationExample() async throws {
    print("\nğŸ›‘ Streaming with Cancellation Example")
    print("======================================")

    let client = try LLMClient(baseURLString: "https://api.openai.com/v1/responses")

    let request = try ResponseRequest(
        model: "gpt-4",
        config: {
            Temperature(0.8)
            MaxOutputTokens(200) // Longer response to demonstrate cancellation
        },
        input: {
            user("Write a detailed story about space exploration")
        }
    )

    print("ğŸš€ Starting streaming response (will cancel after 3 seconds)...")

    let stream = client.stream(request: request)
    var startTime = Date()
    var contentReceived = ""

    do {
        for try await event in stream {
            switch event {
            case .outputItemAdded(let item):
                if case .message(let message) = item,
                   let content = message.content {
                    contentReceived += content
                    print(content, terminator: "")
                    fflush(stdout)

                    // Cancel after 3 seconds
                    if Date().timeIntervalSince(startTime) > 3.0 {
                        print("\n\nğŸ›‘ Cancelling stream after 3 seconds...")
                        break
                    }
                }

            case .completed:
                print("\nâœ… Stream completed naturally")

            default:
                break
            }
        }
    } catch {
        print("\nâŒ Stream error:", error.localizedDescription)
    }

    let wordCount = contentReceived.split(separator: " ").count
    print("ğŸ“Š Partial response received: \(wordCount) words")
    print("âœ… Cancellation example completed!")
}

/// Example 4: Comparing Streaming vs Non-Streaming
/// Shows the difference in user experience between the two approaches
func streamingVsNonStreamingExample() async throws {
    print("\nâš¡ Streaming vs Non-Streaming Comparison")
    print("========================================")

    let client = try LLMClient(baseURLString: "https://api.openai.com/v1/responses")

    let prompt = "Write a short explanation of how photosynthesis works"

    // First, try non-streaming
    print("ğŸ“ Non-Streaming Approach:")
    print("   (Waiting for complete response...)")

    let startTime = Date()

    let nonStreamingRequest = try ResponseRequest(
        model: "gpt-4",
        input: {
            user(prompt)
        }
    )

    let nonStreamingResponse = try await client.respond(to: nonStreamingRequest)
    let nonStreamingTime = Date().timeIntervalSince(startTime)

    if let content = nonStreamingResponse.choices.first?.message.content {
        print("   âœ… Complete response received in \(String(format: "%.2f", nonStreamingTime))s")
        print("   ğŸ¤– \(content.prefix(100))...")
    }

    // Now try streaming
    print("\nğŸŒŠ Streaming Approach:")
    print("   (Receiving response in real-time...)")

    let streamingStartTime = Date()
    var streamingContent = ""

    let streamingRequest = try ResponseRequest(
        model: "gpt-4",
        config: {
            StreamOptions(["include_usage": true])
        },
        input: {
            user(prompt)
        }
    )

    let stream = client.stream(request: streamingRequest)

    for try await event in stream {
        if case .outputItemAdded(let item) = event,
           case .message(let message) = item,
           let content = message.content {
            streamingContent += content
            // Show first part of streaming response
            if streamingContent.count <= 100 {
                print("   ğŸ“ \(streamingContent)", terminator: "")
                fflush(stdout)
            }
        }
    }

    let streamingTime = Date().timeIntervalSince(streamingStartTime)
    print("\n   âœ… Streaming completed in \(String(format: "%.2f", streamingTime))s")

    // Compare the results
    print("\nğŸ“Š Comparison:")
    print("   â€¢ Non-streaming: \(String(format: "%.2f", nonStreamingTime))s (wait for complete)")
    print("   â€¢ Streaming: \(String(format: "%.2f", streamingTime))s (real-time feedback)")
    print("   â€¢ User Experience: Streaming provides immediate feedback!")

    print("âœ… Comparison completed!")
}

/// Example 5: Handling Streaming Errors
/// Shows how to handle errors that can occur during streaming
func streamingErrorHandlingExample() async {
    print("\nğŸš¨ Streaming Error Handling Example")
    print("===================================")

    do {
        // Try with an invalid endpoint to demonstrate error handling
        let client = try LLMClient(baseURLString: "https://invalid-endpoint.com")

        let request = try ResponseRequest(
            model: "gpt-4",
            input: {
                user("Hello")
            }
        )

        let stream = client.stream(request: request)

        for try await event in stream {
            print("ğŸ“¡ Received event:", event)
        }

    } catch LLMError.networkError(let message) {
        print("âŒ Network Error:", message)
        print("ğŸ’¡ In a real app, you might:")
        print("   â€¢ Show a retry button")
        print("   â€¢ Fall back to non-streaming")
        print("   â€¢ Show an offline message")

    } catch LLMError.invalidURL {
        print("âŒ Invalid URL Error")
        print("ğŸ’¡ Check your API endpoint configuration")

    } catch {
        print("âŒ Unexpected Error:", error.localizedDescription)
        print("ğŸ’¡ Log this error for debugging")
    }

    print("âœ… Error handling demonstrated!")
}

/// Main function to run all streaming examples
func runStreamingExamples() async {
    print("ğŸŒŠ SwiftResponsesDSL - Streaming Basics")
    print("=======================================")
    print("Learn how to use streaming responses for real-time interactions.\n")

    do {
        try await basicStreamingExample()
        try await streamingWithProgressExample()
        try await streamingWithCancellationExample()
        try await streamingVsNonStreamingExample()
        await streamingErrorHandlingExample()

        print("\nğŸ‰ All streaming examples completed!")
        print("ğŸ’¡ Next: Try the Intermediate examples for more advanced patterns!")

    } catch {
        print("âŒ Example failed with error:", error.localizedDescription)
    }
}
